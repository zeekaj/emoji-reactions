<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Emoji Reactions</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the emoji animation */
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-200px) scale(1.5);
            }
        }
        .emoji-animation {
            animation: floatUp 2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-green-500 font-sans h-screen overflow-hidden relative">

    <!-- Button Container -->
    <div id="buttonContainer" class="fixed bottom-10 left-1/2 -translate-x-1/2 flex space-x-10">
        <button onclick="sendEmoji('👏')" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105">👏 Clap</button>
        <button onclick="sendEmoji('👍')" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105">👍 Thumbs Up</button>
        <button onclick="sendEmoji('❤️')" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105">❤️ Love</button>
        <button onclick="sendEmoji('😊')" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105">😊 Happy</button>
        <button onclick="sendEmoji('🎈')" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105">🎈 Balloons</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- AUTHENTICATION ---
        // Use the provided auth token if available, otherwise sign in anonymously
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase authentication successful.");
                setupListeners();
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }
        signIn();

        // Get the buttons and container
        const buttonContainer = document.getElementById('buttonContainer');
        const buttons = Array.from(buttonContainer.querySelectorAll('button'));

        /**
         * Sends an emoji reaction to Firestore.
         * @param {string} symbol The emoji character.
         */
        async function sendEmoji(symbol) {
            try {
                const buttonIndex = buttons.findIndex(btn => btn.textContent.includes(symbol));
                if (buttonIndex === -1) {
                    console.error("Button not found for symbol:", symbol);
                    return;
                }
                await addDoc(collection(db, `artifacts/${appId}/public/data/emojis`), {
                    symbol: symbol,
                    buttonIndex: buttonIndex,
                    timestamp: serverTimestamp()
                });
                console.log("Emoji sent to Firestore.");
            } catch (error) {
                console.error("Error sending emoji:", error);
            }
        }
        
        // Expose function to the global scope for onclick attributes
        window.sendEmoji = sendEmoji;

        /**
         * Shows an emoji animation on the screen.
         * @param {string} symbol The emoji character to display.
         * @param {number} buttonIndex The index of the button to align with.
         */
        function showEmoji(symbol, buttonIndex) {
            const button = buttons[buttonIndex];
            if (!button) return;
            const rect = button.getBoundingClientRect();

            // Create the emoji element
            const emoji = document.createElement('div');
            emoji.textContent = symbol;
            
            // Add Tailwind classes for styling and positioning
            emoji.className = `absolute text-5xl pointer-events-none emoji-animation`;

            // Calculate horizontal position to align with the button center
            emoji.style.left = `${rect.left + rect.width / 2}px`;
            
            // Set vertical position to the center of the page
            emoji.style.top = `50%`;
            
            // Use transform to precisely center the element itself
            emoji.style.transform = 'translate(-50%, -50%)';

            document.body.appendChild(emoji);

            // Remove the emoji after the animation completes
            setTimeout(() => {
                emoji.remove();
            }, 2000);
        }

        // --- FIRESTORE LISTENER ---
        function setupListeners() {
            const emojisQuery = query(collection(db, `artifacts/${appId}/public/data/emojis`));
            
            // Listen for new emoji documents
            onSnapshot(emojisQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        // This logic is for new emojis only
                        showEmoji(data.symbol, data.buttonIndex);
                    }
                });
            });
        }
    </script>
</body>
</html>
